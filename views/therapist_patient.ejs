<!DOCTYPE html>
<html>
<head>

    <title>Assign Exercises to <%= escapeHTML(patient.name) %> <%= escapeHTML(patient.surname) %></title>
  <link rel="stylesheet" href="<%= BASE_PATH %>/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header-title">
      <img src="<%= BASE_PATH %>/exercises/img/nhs.svg" alt="NHS Logo" class="header-logo">
      <h1 class="header-title-text">PhysioHUB</h1>
    </div>
    <hr>

        <h2>Patient:<br></h2> 
        <h1><%= escapeHTML(patient.name) %> <%= escapeHTML(patient.surname) %></h1>
        <hr>
        <br>
        <h2>Illness:<br></h2>
        <h3><%= escapeHTML(patient.illness) || 'Not specified' %></h3>

        <% if (messages.success) { %>
          <p class="success"><%= messages.success %></p>
        <% } %>
        <% if (messages.error) { %>
          <p class="error"><%= messages.error %></p>
        <% } %>


        <form method="POST" action="<%= BASE_PATH %>/therapist/assign/<%= patient.id %>" id="assignment-form">
            <div class="selection-row">
                <h3>1. Select and Add Exercises</h3><br>
                <label for="exercise-select">Available Exercises:</label><br><br>
                <select id="exercise-select">
                    <option value="">-- Choose an Exercise --</option>
                    <% exercises.forEach(ex => { %>
                        <option value='<%= JSON.stringify({
                            id: ex.id,
                            name: ex.name,
                            description: ex.description,
                            illustration_sequence: ex.illustration_sequence,
                            aim: ex.aim || 'To strengthen the affected area.'
                        }) %>'>

                    <%= escapeHTML(ex.name) %>
                        </option>
                    <% }); %>
                </select>
                <br><br>
                <button type="button" id="add-exercise-btn">Add Exercise</button>
            </div>

            <h3>2. Configure and Prescribe</h3><br>
            <div id="prescribed-exercises">
                <p id="no-exercises-message">No exercises assigned yet. Please select one above.</p>
            </div>

            <hr><br><br>
            <button type="submit">Assign Exercises & Send Confirmation</button>
        </form>

        <br>
        <a href="<%= BASE_PATH %>/therapist/dashboard">‚Üê Back to Dashboard</a>

        <a href="<%= BASE_PATH %>/logout" style="margin-left: 20px;">Logout</a>
    </div>

    <script>
        const BASE_PATH = "<%= BASE_PATH %>";

        const selectElement = document.getElementById('exercise-select');
        const addBtn = document.getElementById('add-exercise-btn');
        const prescribedContainer = document.getElementById('prescribed-exercises');
        const noExercisesMessage = document.getElementById('no-exercises-message');
        
        const assignedExerciseIds = new Set();

        function renderExercisePartial(exerciseData) {
            return `
                <div class="exercise-item" data-id="${exerciseData.id}" style="text-align: center; margin-bottom: 50px;">
                    <hr>
                    <h3>${exerciseData.name}</h3>
                    <div class="exercise-details" style="display: inline-block; text-align: center; max-width: 400px;">
                        <img src="<%= BASE_PATH %>/exercises/img/${exerciseData.illustration_sequence}.jpg" 
                            alt="${exerciseData.name}" 
                            class="exercise-preview-img"
                            style="max-width: 350px; height: auto; display: block; margin: 20px auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); background: #f0f0f0;">

                        <p><strong>Client's Aim:</strong> ${exerciseData.aim || 'To be determined.'}</p>
                        <p><strong>Instructions:</strong> ${exerciseData.description}</p>

                        <div style="margin: 30px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 8px;">DURATION (seconds):</label>
                            <input type="number" 
                                   name="exercises[${exerciseData.id}][duration]" 
                                   value="5" min="1" required 
                                   style="width: 100px; padding: 10px; font-size: 1.1rem; text-align: center; border-radius: 12px; border: none;">

                            <label style="display: block; font-weight: bold; margin: 25px 0 8px 0;">REPETITIONS:</label>
                            <input type="number" 
                                   name="exercises[${exerciseData.id}][reps]" 
                                   value="10" min="1" required 
                                   style="width: 100px; padding: 10px; font-size: 1.1rem; text-align: center; border-radius: 12px; border: none;">

                            <label style="display: block; font-weight: bold; margin: 25px 0 8px 0;">WEEKLY SESSIONS:</label>
                            <input type="number" 
                                   name="exercises[${exerciseData.id}][perWeek]" 
                                   value="3" min="1" required 
                                   style="width: 100px; padding: 10px; font-size: 1.1rem; text-align: center; border-radius: 12px; border: none;">
                        </div>

                        <input type="hidden" name="exercises[${exerciseData.id}][id]" value="${exerciseData.id}">
                        <input type="hidden" name="exercises[${exerciseData.id}][name]" value="${exerciseData.name}">
                        <input type="hidden" name="exercises[${exerciseData.id}][illustration_sequence]" value="${exerciseData.illustration_sequence}">

                        <button type="button" class="remove-exercise-btn" data-id="${exerciseData.id}" 
                                style="margin-top: 20px; padding: 12px 30px; background: #dc3545; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        }

        function handleAddExercise() {
            const selected = selectElement.options[selectElement.selectedIndex];
            if (!selected.value) return;

            let exerciseData;
            try {
                exerciseData = JSON.parse(selected.value);
            } catch (e) {
                console.error("Failed to parse exercise data");
                return;
            }

            if (assignedExerciseIds.has(exerciseData.id)) {
                alert("This exercise is already assigned!");
                return;
            }

            prescribedContainer.insertAdjacentHTML('beforeend', renderExercisePartial(exerciseData));
            assignedExerciseIds.add(exerciseData.id);
            noExercisesMessage.style.display = 'none';
            selectElement.selectedIndex = 0;
        }

        function handleRemoveExercise(e) {
            if (e.target.classList.contains('remove-exercise-btn')) {
                const id = parseInt(e.target.dataset.id);
                const item = e.target.closest('.exercise-item');
                if (item) item.remove();
                assignedExerciseIds.delete(id);

                if (assignedExerciseIds.size === 0) {
                    noExercisesMessage.style.display = 'block';
                }
            }
        }

        addBtn.addEventListener('click', handleAddExercise);
        prescribedContainer.addEventListener('click', handleRemoveExercise);

        if (assignedExerciseIds.size === 0) {
            noExercisesMessage.style.display = 'block';
        }
    </script>
</body>
</html>