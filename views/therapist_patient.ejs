<!DOCTYPE html>
<html>
<head>
  <title>Assign Exercises to <%= patient.name %> <%= patient.surname %></title>
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

<style>
        /* Custom Styles for Therapist Assignment Interface */
        .exercise-details p { margin-top: 20px; margin-bottom: 20px; }
        .exercise-details img {  padding: 5px; margin-top: 10px; }
        .selection-row { margin-bottom: 20px; }
        /* Inputs stacked vertically for clarity in assignment block */
        .inline-input { display: block; margin: 5px 0 10px 0; width: 250px; } 
        .exercise-item { padding: 30 px; margin-bottom: 30px; }
        .exercise-details label { display: block; font-weight: bold; margin-top: 5px; }
        /* Make remove button clearly visible */
        .remove-exercise-btn { background-color: #dc3545; color: white; border: none; padding: 10px 10px; cursor: pointer; margin-top: 50px; }
        .remove-exercise-btn:hover { background-color: #c82333; }
  </style>
</head>
<body>
    <h1>NHS PhysioHUB</h1>
    <hr>
  <h1>Patient: <%= patient.name %> <%= patient.surname %></h1>
  <hr>
  <br>
  <h2>Illness: <%= patient.illness %></h2>
  
  <% if (messages.success) { %><p class="success"><%= messages.success %></p><% } %>
  <% if (messages.error) { %><p class="error"><%= messages.error %></p><% } %>
  
  <form method="POST" action="/therapist/assign/<%= patient.id %>" id="assignment-form">
    
    <div class="selection-row">
        <h3>1. Select and Add Exercises</h3><br>
        <label for="exercise-select">Available Exercises:</label><br>
        <select id="exercise-select">
            <option value="">-- Choose an Exercise --</option>
            <% exercises.forEach(ex => { %>
                <option value='<%= JSON.stringify({ 
                        id: ex.id, 
                        name: ex.name, 
                        description: ex.description, 
                        illustration_sequence: ex.illustration_sequence,
                        aim: ex.aim || 'To strengthen the affected area.' 
                    }) %>'>
                    <%= ex.name %>
                </option>
            <% }); %>
        </select><br>
        <button type="button" id="add-exercise-btn">Add</button>
    </div>

    <h3>2. Configure and Prescribe</h3><br>
    <div id="prescribed-exercises">
        <p id="no-exercises-message">No exercises assigned yet. Please select one above.<br></p><br>
    </div>

    <hr><br><br>
    <button type="submit">Assign Exercises & Send Confirmation</button>
  </form>
  <br>
  <a href="/therapist/dashboard">Back</a>

    <script>
        const selectElement = document.getElementById('exercise-select');
        const addBtn = document.getElementById('add-exercise-btn');
        const prescribedContainer = document.getElementById('prescribed-exercises');
        const noExercisesMessage = document.getElementById('no-exercises-message');
        
        let assignedExerciseIds = new Set(); 

            function renderExercisePartial(exerciseData) {
                return `
                <div class="exercise-item" data-id="${exerciseData.id}">
                    <hr>
                    <h3>${exerciseData.name}</h3>
                    <div class="exercise-details">
                        <img src="/exercises/img/${exerciseData.illustration_sequence}.jpg" alt="${exerciseData.name}" style="max-width: 200px; display: block; margin-bottom: 10px;">
                        <p><strong>Client's Aim:</strong> ${exerciseData.aim || 'To be determined.'}</p>
                        <p><strong>Instructions:</strong> ${exerciseData.description}</p>
                        
                        <label for="duration_${exerciseData.id}">DURATION (sec):</label>
                        <input type="number" id="duration_${exerciseData.id}" name="exercises[${exerciseData.id}][duration]" value="5" min="1" required class="inline-input" style="width: 80px;">
                        
                        <label for="reps_${exerciseData.id}">REPETITION (t)</label>
                        <input type="number" id="reps_${exerciseData.id}" name="exercises[${exerciseData.id}][reps]" value="10" min="1" required class="inline-input" style="width: 80px;">
                        
                        <label for="perWeek_${exerciseData.id}">WEEKLY REP (w)</label>
                        <input type="number" id="perWeek_${exerciseData.id}" name="exercises[${exerciseData.id}][perWeek]" value="3" min="1" required class="inline-input" style="width: 80px;">
                        
                        <input type="hidden" name="exercises[${exerciseData.id}][id]" value="${exerciseData.id}">
                        <input type="hidden" name="exercises[${exerciseData.id}][name]" value="${exerciseData.name}">
                        <input type="hidden" name="exercises[${exerciseData.id}][illustration_sequence]" value="${exerciseData.illustration_sequence}">
                        
                        <button type="button" class="remove-exercise-btn" data-id="${exerciseData.id}">Remove</button>
                    </div>
                </div>
            `;
        }

            function handleAddExercise() {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (!selectedOption.value) return;

                try {
                const exerciseData = JSON.parse(selectedOption.value);
                
                if (assignedExerciseIds.has(exerciseData.id)) {
                    alert('This exercise is already assigned!');
                    return;
                }

                    // Append the rendered HTML to the container
                prescribedContainer.insertAdjacentHTML('beforeend', renderExercisePartial(exerciseData));
                assignedExerciseIds.add(exerciseData.id);
                
                // Hide the "No exercises assigned yet" message
                if (noExercisesMessage) {
                    noExercisesMessage.style.display = 'none';
                }

                    // Reset selection to the placeholder
                selectElement.selectedIndex = 0;
            } catch (error) {
                console.error("Error parsing exercise data:", error);
            }
        }

            function handleRemoveExercise(event) {
            if (event.target.classList.contains('remove-exercise-btn')) {
                const button = event.target;
                const exerciseId = parseInt(button.getAttribute('data-id'));
                const exerciseItem = button.closest('.exercise-item');
                
                if (exerciseItem) {
                    exerciseItem.remove();
                    assignedExerciseIds.delete(exerciseId);
                }

                    // Show the "No exercises assigned yet" message if the list is empty
                if (assignedExerciseIds.size === 0 && noExercisesMessage) {
                    noExercisesMessage.style.display = 'block';
                }
            }
        }

        addBtn.addEventListener('click', handleAddExercise);
        prescribedContainer.addEventListener('click', handleRemoveExercise);

        // Initial check to show/hide the message
        if (assignedExerciseIds.size === 0 && noExercisesMessage) {
            noExercisesMessage.style.display = 'block';
        }
    </script>
</body>
</html>
