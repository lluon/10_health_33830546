<!DOCTYPE html>
<html>
<head>
  <title>Patient Dashboard</title>
  <link rel="stylesheet" href="<%= BASE_PATH %>/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>NHS PhysioHUB</h1>
    <hr>
    <h2>Patient Dashboard - <%= escapeHTML(patient.name) %> <%= escapeHTML(patient.surname) %></h2>
    <br><hr>

    <% if (messages.success) { %>
      <p class="success"><%= messages.success %></p>
    <% } %>
    <% if (messages.error) { %>
      <p class="error"><%= messages.error %></p>
    <% } %>

    <!-- Illness submission form (shown only if no illness recorded yet) -->
    <% if (!patient.illness) { %>
      <h2>Submit Your Illness Description</h2>
      <form method="POST" action="<%= BASE_PATH %>/patient/illness">
        <textarea name="illness" placeholder="Describe your illness or symptoms in detail" required style="height: 150px;"></textarea>
        <button type="submit">Submit</button>
      </form>
      <br><hr><br>
    <% } %>

    <!-- Show submitted illness -->
    <% if (patient.illness) { %>
      <p><strong>Your Reported Condition:</strong><br>
         <%= escapeHTML(patient.illness) %></p>
      <br><hr><br>
    <% } %>

    <!-- Awaiting treatment assignment -->
    <% if (patient.illness && !patient.attended) { %>
      <h2>Status: Awaiting Treatment Plan</h2>
      <p>Your description has been submitted. Please wait while your physiotherapist reviews it and assigns a personalised treatment plan.</p>
      <br><hr><br>
    <% } %>

    <!-- Active treatment plan -->
    <% if (treatment) { %>
      <h2>Ongoing Treatment Plan</h2>
      <br>
      <p><strong>Timing:</strong> <%= escapeHTML(treatment.timing) %></p>
      <p><strong>Progression Notes:</strong> <%= escapeHTML(treatment.progression) %></p>
      <br><hr><br>

      <h3>Your Prescribed Exercises</h3>
      <% if (exercises.length === 0) { %>
        <p>No exercises assigned yet.</p>
      <% } else { %>
        <ul style="list-style: none; padding: 0;">
          <% exercises.forEach(ex => { %>
            <% 
              let params = {};
              try {
                if (ex.custom_checklist) {
                  params = JSON.parse(ex.custom_checklist);
                } else {
                  params = JSON.parse(ex.checklist || '{"duration": "N/A", "reps": "N/A", "perWeek": "N/A"}');
                }
              } catch (e) {
                console.error("Failed to parse checklist for exercise:", ex.name);
                params = { duration: "N/A", reps: "N/A", perWeek: "N/A" };
              }
            %>
            <li style="text-align: center; margin-bottom: 50px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
              <a href="<%= BASE_PATH %>/exercise/<%= ex.id %>">
                <strong><%= escapeHTML(ex.name) %></strong>
              </a>
              <br><br>
              <img src="<%= BASE_PATH %>/exercises/img/<%= ex.illustration_sequence %>.jpg"
                   alt="<%= escapeHTML(ex.name) %>"
                   style="max-width: 200px; display: block; margin: 20px auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
              <p><strong>Instructions:</strong><br><%= escapeHTML(ex.description) %></p>
              <br>
              <h4>Prescription Details</h4>
              <p>
                <strong>Duration per repetition:</strong> <%= params.duration %> seconds<br>
                <strong>Repetitions/Sets:</strong> <%= params.reps %><br>
                <strong>Weekly Sessions:</strong> <%= params.perWeek %>
              </p>
              <br>
              <a href="<%= BASE_PATH %>/exercise/<%= ex.id %>" class="action-btn" style="background: #007bff; display: inline-block;">Start Exercise</a>
            </li>
          <% }); %>
        </ul>
      <% } %>
    <% } else if (patient.attended && !treatment) { %>
      <p>Your treatment plan is ready, but no exercises have been assigned yet. Please check back later.</p>
    <% } %>

    <br><br><hr><br>
    <a href="<%= BASE_PATH %>/">Home</a>
    <a href="<%= BASE_PATH %>/logout" style="margin-left: 20px;">Logout</a>
  </div>
</body>
</html>